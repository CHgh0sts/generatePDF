{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/chghosts/Developpement/test%20gemini%203/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\n\nexport const prisma = globalForPrisma.prisma || new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///Users/chghosts/Developpement/test%20gemini%203/app/api/generate/%5Bslug%5D/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\n\n// Fonction pour extraire une valeur depuis un objet JSON avec notation pointée\nfunction getValueByPath(obj: any, path: string): any {\n  return path.split('.').reduce((current, key) => current?.[key], obj);\n}\n\n// POST - Générer un PDF depuis une route API\nexport async function POST(\n  request: Request,\n  { params }: { params: Promise<{ slug: string }> }\n) {\n  try {\n    const { slug } = await params;\n\n    // Récupérer la route API\n    const apiRoute = await prisma.apiRoute.findUnique({\n      where: { slug },\n      include: {\n        template: true\n      }\n    });\n\n    if (!apiRoute) {\n      return NextResponse.json({ error: 'Route non trouvée' }, { status: 404 });\n    }\n\n    if (!apiRoute.isActive) {\n      return NextResponse.json({ error: 'Route désactivée' }, { status: 403 });\n    }\n\n    // Vérifier la clé API si requise\n    if (apiRoute.apiKey) {\n      const apiKey = request.headers.get('X-API-Key') || new URL(request.url).searchParams.get('apiKey');\n      if (apiKey !== apiRoute.apiKey) {\n        return NextResponse.json({ error: 'Clé API invalide' }, { status: 401 });\n      }\n    }\n\n    // Récupérer les données JSON envoyées (peut être vide)\n    let jsonData = {};\n    try {\n      const text = await request.text();\n      if (text && text.trim()) {\n        jsonData = JSON.parse(text);\n      }\n    } catch (e) {\n      // Si pas de body ou body invalide, utiliser un objet vide\n      jsonData = {};\n    }\n\n    // Parser le mapping des variables\n    let variableMapping: Record<string, string> = {};\n    try {\n      variableMapping = JSON.parse(apiRoute.variableMapping) as Record<string, string>;\n    } catch (e) {\n      // Si pas de mapping, utiliser un objet vide\n      variableMapping = {};\n    }\n\n    // Parser le template\n    const templateData = JSON.parse(apiRoute.template.content);\n    const elements = templateData.elements || [];\n    const globalSettings = templateData.globalSettings;\n\n    // Appliquer le mapping des variables\n    const processedElements = elements.map((element: any) => {\n      if (element.type === 'text' && element.content) {\n        let newContent = element.content;\n\n        // Remplacer chaque variable du template par la valeur correspondante du JSON\n        Object.entries(variableMapping).forEach(([jsonPath, templateVar]) => {\n          const value = getValueByPath(jsonData, jsonPath);\n          if (value !== undefined) {\n            // Enlever les accolades de la variable template si présentes\n            const cleanVar = templateVar.replace(/[{}]/g, '');\n            newContent = newContent.replace(new RegExp(`{{${cleanVar}}}`, 'g'), String(value));\n          }\n        });\n\n        return { ...element, content: newContent };\n      }\n      return element;\n    });\n\n    // Selon le type de réponse demandé\n    if (apiRoute.responseType === 'base64') {\n      // Retourner les données en JSON pour que le client génère le PDF\n      return NextResponse.json({\n        elements: processedElements,\n        globalSettings,\n        format: 'base64'\n      });\n    } else if (apiRoute.responseType === 'url') {\n      // TODO: Implémenter le stockage et retourner une URL\n      return NextResponse.json({\n        message: 'Type URL pas encore implémenté',\n        elements: processedElements,\n        globalSettings\n      });\n    } else {\n      // responseType === 'download'\n      // Retourner les données pour génération côté client\n      // Note: La génération réelle du PDF nécessite html2canvas qui ne fonctionne que côté client\n      return NextResponse.json({\n        elements: processedElements,\n        globalSettings,\n        templateName: apiRoute.template.name,\n        format: 'download'\n      });\n    }\n  } catch (error) {\n    console.error('Erreur génération PDF:', error);\n    return NextResponse.json({ \n      error: 'Erreur lors de la génération',\n      details: (error as Error).message \n    }, { status: 500 });\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,+EAA+E;AAC/E,SAAS,eAAe,GAAQ,EAAE,IAAY;IAC5C,OAAO,KAAK,KAAK,CAAC,KAAK,MAAM,CAAC,CAAC,SAAS,MAAQ,SAAS,CAAC,IAAI,EAAE;AAClE;AAGO,eAAe,KACpB,OAAgB,EAChB,EAAE,MAAM,EAAyC;IAEjD,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM;QAEvB,yBAAyB;QACzB,MAAM,WAAW,MAAM,yHAAM,CAAC,QAAQ,CAAC,UAAU,CAAC;YAChD,OAAO;gBAAE;YAAK;YACd,SAAS;gBACP,UAAU;YACZ;QACF;QAEA,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,IAAI,CAAC,SAAS,QAAQ,EAAE;YACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,iCAAiC;QACjC,IAAI,SAAS,MAAM,EAAE;YACnB,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,gBAAgB,IAAI,IAAI,QAAQ,GAAG,EAAE,YAAY,CAAC,GAAG,CAAC;YACzF,IAAI,WAAW,SAAS,MAAM,EAAE;gBAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAmB,GAAG;oBAAE,QAAQ;gBAAI;YACxE;QACF;QAEA,uDAAuD;QACvD,IAAI,WAAW,CAAC;QAChB,IAAI;YACF,MAAM,OAAO,MAAM,QAAQ,IAAI;YAC/B,IAAI,QAAQ,KAAK,IAAI,IAAI;gBACvB,WAAW,KAAK,KAAK,CAAC;YACxB;QACF,EAAE,OAAO,GAAG;YACV,0DAA0D;YAC1D,WAAW,CAAC;QACd;QAEA,kCAAkC;QAClC,IAAI,kBAA0C,CAAC;QAC/C,IAAI;YACF,kBAAkB,KAAK,KAAK,CAAC,SAAS,eAAe;QACvD,EAAE,OAAO,GAAG;YACV,4CAA4C;YAC5C,kBAAkB,CAAC;QACrB;QAEA,qBAAqB;QACrB,MAAM,eAAe,KAAK,KAAK,CAAC,SAAS,QAAQ,CAAC,OAAO;QACzD,MAAM,WAAW,aAAa,QAAQ,IAAI,EAAE;QAC5C,MAAM,iBAAiB,aAAa,cAAc;QAElD,qCAAqC;QACrC,MAAM,oBAAoB,SAAS,GAAG,CAAC,CAAC;YACtC,IAAI,QAAQ,IAAI,KAAK,UAAU,QAAQ,OAAO,EAAE;gBAC9C,IAAI,aAAa,QAAQ,OAAO;gBAEhC,6EAA6E;gBAC7E,OAAO,OAAO,CAAC,iBAAiB,OAAO,CAAC,CAAC,CAAC,UAAU,YAAY;oBAC9D,MAAM,QAAQ,eAAe,UAAU;oBACvC,IAAI,UAAU,WAAW;wBACvB,6DAA6D;wBAC7D,MAAM,WAAW,YAAY,OAAO,CAAC,SAAS;wBAC9C,aAAa,WAAW,OAAO,CAAC,IAAI,OAAO,CAAC,EAAE,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,OAAO;oBAC7E;gBACF;gBAEA,OAAO;oBAAE,GAAG,OAAO;oBAAE,SAAS;gBAAW;YAC3C;YACA,OAAO;QACT;QAEA,mCAAmC;QACnC,IAAI,SAAS,YAAY,KAAK,UAAU;YACtC,iEAAiE;YACjE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,UAAU;gBACV;gBACA,QAAQ;YACV;QACF,OAAO,IAAI,SAAS,YAAY,KAAK,OAAO;YAC1C,qDAAqD;YACrD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,UAAU;gBACV;YACF;QACF,OAAO;YACL,8BAA8B;YAC9B,oDAAoD;YACpD,4FAA4F;YAC5F,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,UAAU;gBACV;gBACA,cAAc,SAAS,QAAQ,CAAC,IAAI;gBACpC,QAAQ;YACV;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO;YACP,SAAS,AAAC,MAAgB,OAAO;QACnC,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}